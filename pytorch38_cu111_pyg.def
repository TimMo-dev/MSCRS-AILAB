Bootstrap: docker
From: nvidia/cuda:11.1.1-cudnn8-runtime-ubuntu20.04

%labels
    Description PyTorch 1.8.1 (cu111) + PyG 2.0.1 + Transformers 4.15.0 + Accelerate 0.8.0 on Ubuntu 20.04 / Python 3.8.x

%setup
    mkdir -p "$SINGULARITY_ROOTFS/root"
    cp requirements.txt "$SINGULARITY_ROOTFS/root/requirements.txt"

%post
    set -e

    apt-get update && apt-get install -y --no-install-recommends \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        git \
        curl \
        ca-certificates \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    # Make `python` point to python3
    ln -sf /usr/bin/python3 /usr/local/bin/python

    # Upgrade pip tooling
    python -m pip install --no-cache-dir --upgrade pip setuptools wheel

    # ---- Install PyTorch 1.8.1 + CUDA 11.1 wheels ----
    # NOTE: This installs the official cu111 wheel, not CPU-only.
    pip install --no-cache-dir \
        torch==1.8.1+cu111 \
        torchvision==0.9.1+cu111 \
        torchaudio==0.8.1 \
        -f https://download.pytorch.org/whl/torch_stable.html

    # ---- Install requested libs ----

    ls -la /root/requirements.txt
    pip install --no-cache-dir -r /root/requirements.txt

    # ---- Install PyG stack for torch 1.8.1 + cu111 ----
    pip install --no-cache-dir \
        torch-scatter==2.0.9 \
        torch-sparse==0.6.12 \
        torch-cluster==1.5.9 \
        torch-spline-conv==1.2.1 \
        -f https://data.pyg.org/whl/torch-1.8.1+cu111.html

    pip install --no-cache-dir torch-geometric==2.0.1

%environment
    export LC_ALL=C
    export LANG=C
    # Ensure python/pip are on PATH
    export PATH=/usr/local/bin:/usr/bin:/bin:$PATH

%runscript
    exec python "$@"

%test
    set -e
    python -c "import sys; print('python', sys.version)"
    python -c "import torch; print('torch', torch.__version__, 'cuda?', torch.cuda.is_available())"
    python -c "import transformers; print('transformers', transformers.__version__)"
    python -c "import accelerate; print('accelerate', accelerate.__version__)"
    python -c "import torch_geometric; print('torch_geometric', torch_geometric.__version__)"

